{% extends 'index.html' %}
{% block title %} | {{ state|capitalize }}{% endblock %}
{% block headcss %}<link href="/static/css/main.css" rel="stylesheet">{% endblock %}
{% block left_nav %}
<li><a href="/{{ state }}/trajectory" data-name="trajectory">Set RPS trajectory</a></li>
<li class="active"><a href data-name="carveouts">Set carveouts</a></li>
<li><a href="/{{ state }}/pricing" data-name="pricing">Set cost cap &amp; pricing</a></li>
<li><a href="/{{ state }}/cost" data-name="cost">Projected cost</a></li>
{% endblock %}
{% block content %}
  <article id="main_content">
    {{ super() }}
    <section class="clearfix">
      <h2>Carveouts</h2>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenean et metus vitae neque molestie hendrerit
        eget eget dolor. Sed felis diam, imperdiet eget nulla ornare, semper viverra ante. Pellentesque in risus
        sem. In nisl velit, pellentesque in elit at, adipiscing sodales metus. Vestibulum faucibus placerat
        lectus at aliquam.</p>
      <div id="carveouts" class="module clearfix chart-outer-wrap">
      </div>
      <p>Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae;
        Donec sodales semper erat. Suspendisse molestie turpis tempor leo dictum, commodo lacinia tellus laoreet.
        Sed consequat felis eget nulla vulputate, placerat pulvinar sapien rhoncus. Nam mollis est neque, faucibus
        consequat arcu hendrerit id. Sed feugiat ultrices volutpat. Nam volutpat aliquam ultricies. Phasellus
        orci erat, pretium eget velit ut, congue sodales massa. Aliquam erat volutpat.</p>
      <ul id="crumbs">
        <li id="crumb_trajectory"><a href="/{{ state }}/trajectory">Trajectory</a>
        <li id="crumb_carveouts" class="active"><a href="/{{ state }}/carveouts">Carveouts</a></li>
        <li id="crumb_pricing"><a href="/{{ state }}/pricing">Cost cap &amp; Pricing</a></li>
        <li id="crumb_cost"><a href="/{{ state }}/cost">Projected Cost</a></li>
      </ul>
    </section>
  </article>
{% endblock %}
{% block bodyjs %}
  <script>
    Options = window.Options || {};
    Options.state = '{{ state }}';
    Options.graph_type = '{{ graph_type }}';
  </script>
  <script src="/static/js/vendor/d3.v3.min.js" charset="utf-8"></script>
  <script src="/static/js/graphs/stacked_chart.js"></script>
  <script>
    var width = 760,
        height = 400,
        padding = 30,
        empty = true,
        container = '#carveouts',
        carveout_types = ['wind', 'solar'],
        parse_date = d3.time.format('%Y').parse;
    d3.json('/static/js/data/states/' + Options.state + '.json', function(_data) {
      var def_line = [{data: []}],
          data = [{type: 'wind', data: []}, {type: 'solar', data: []}];
      // Parse trajectory data
      //TODO: Rewrite JSON carveouts as percent of RPS, not percent of total energy
      //TODO: The loop below is total crap
      for (var i = 0; i < carveout_types.length; ++i) {
        var carveout_type = carveout_types[i],
          carveout_data = data.filter(function(e) { return e.type === carveout_type })[0],
          carveout = _data.carveouts.filter(function(d) { return d.type === carveout_type; });
        empty = empty ? carveout.length === 0 : false;
        carveout = carveout.length > 0 ? carveout[0].data : [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
        carveout.forEach(function(d, ii) {
          var _t = _data.trajectory[ii];
          carveout_data.data[ii]= {x: parse_date(String(ii + 2000)), y: _t === 0 ? 0 : d / _data.trajectory[ii] * 100, type: carveout_type};
        });
      }
      data.sort(function(a, b) { return a.data[a.data.length-1].y < b.data[b.data.length-1].y ? -1 : a.data[a.data.length-1].y > b.data[b.data.length-1].y ? 1 : 0 });
      var foo = new RPSGraph()
        .padding(30)
        .width(width).height(height)
        .select(container)
        .title('Adjust the state&rsquo;s carveouts')
        .x(d3.time.scale())
        .y(d3.scale.linear())
        .domain([new Date(2013, 0, 1), new Date(2030, 0, 1)], [0, 100])
        .max_domains([50, 100])
        .format_x(function(x) { return x.getFullYear(); })
        .format_y(function(y) { return d3.format('.1f')(y); })
        .data(data)
        .stacked(true)
        .hoverable(true)
        .draggable(true, false)
        .h_grid(true)
        .draw()
        .zeroes(empty);
    });
  </script>
{% endblock %}